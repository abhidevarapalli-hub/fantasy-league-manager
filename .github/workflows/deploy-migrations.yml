name: Deploy Migrations

on:
  push:
    branches: [main]
    paths:
      - "supabase/migrations/**"

  # Allow manual trigger for deploying migrations on demand
  workflow_dispatch:

concurrency:
  group: deploy-migrations
  cancel-in-progress: false

jobs:
  validate:
    name: Validate Migrations
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: supabase/setup-cli@v1
        with:
          version: latest
      - name: Start local Supabase
        run: supabase start -x edge-runtime,logflare,vector,imgproxy,studio
      - name: Apply migrations locally
        run: |
          supabase db reset --debug 2>&1 | tail -20
          echo "Migration validation passed"

  deploy:
    name: Deploy to Production
    needs: validate
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: supabase/setup-cli@v1
        with:
          version: latest
      - name: Link to production project
        run: supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      - name: Push migrations to production
        run: supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
      - name: Verify deployment
        run: |
          echo "Migrations deployed successfully to production"
          echo "Project: ${{ secrets.SUPABASE_PROJECT_REF }}"
